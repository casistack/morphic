# This is a Docker Compose file for setting up the morphic-stack environment.

version: '3.9'
services:
  morphic:
    build:
      context: .
      dockerfile: Dockerfile
    command: bun start -H 0.0.0.0
    ports:
      - ":3000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_API_MODEL=${OPENAI_API_MODEL:-gpt-4o-mini}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_SUB_MODEL=${OLLAMA_SUB_MODEL}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
      - USE_SPECIFIC_API_FOR_WRITER=${USE_SPECIFIC_API_FOR_WRITER}
      - SPECIFIC_API_BASE=${SPECIFIC_API_BASE}
      - SPECIFIC_API_KEY=${SPECIFIC_API_KEY}
      - SPECIFIC_API_MODEL=${SPECIFIC_API_MODEL}
      - ENABLE_SHARE=${ENABLE_SHARE}
      - SERPER_API_KEY=${SERPER_API_KEY}
      - USE_LOCAL_REDIS=${USE_LOCAL_REDIS:-true}
      - LOCAL_REDIS_URL=${LOCAL_REDIS_URL:-redis://redis:6379}
      - SEARXNG_API_URL=${SEARXNG_API_URL:-http://searxng:8080}
      - SEARCH_API=${SEARCH_API:-searxng}
      - SEARXNG_IMAGE_PROXY=${SEARXNG_IMAGE_PROXY:-true}
      - SEARXNG_SECRET=${SEARXNG_SECRET}
      - SEARXNG_LIMITER=${SEARXNG_LIMITER:-false}
      - SEARXNG_DEFAULT_DEPTH=${SEARXNG_DEFAULT_DEPTH:-100}
      - SEARXNG_MAX_RESULTS=${SEARXNG_MAX_RESULTS:-100}
      - SEARXNG_CRAWL_MULTIPLIER=${SEARXNG_CRAWL_MULTIPLIER:-4}
      - SEARXNG_ENGINES=${SEARXNG_ENGINES:-google,bing,duckduckgo,wikipedia}
      - SEARXNG_TIME_RANGE=${SEARXNG_TIME_RANGE:-None}
      - SEARXNG_SAFESEARCH=${SEARXNG_SAFESEARCH:-0}
      - SEARXNG_DEFAULT_DEPTH=${SEARXNG_DEFAULT_DEPTH:-advanced}
      - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
    restart: unless-stopped
    depends_on:
      - redis
      - searxng

  redis:
    image: redis:alpine
    ports:
      - ":6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  searxng:
    build:
       context: .
       dockerfile: Dockerfile.searxng
    ports:
      - ":8080"
    environment:
      - SEARXNG_SECRET=${SEARXNG_SECRET}
      - SEARXNG_BIND_ADDRESS=${SEARXNG_BIND_ADDRESS:-0.0.0.0}
      - SEARXNG_IMAGE_PROXY=${SEARXNG_IMAGE_PROXY:-true}
      - SEARXNG_LIMITER=${SEARXNG_LIMITER:-false}
      - SEARXNG_PUBLIC_INSTANCE=${SEARXNG_PUBLIC_INSTANCE:-false}
      - SEARXNG_SAFESEARCH=${SEARXNG_SAFESEARCH:-0}
      - SEARXNG_PORT=${SEARXNG_PORT:-8080}
      - SEARX_SETTINGS_PATH=${SEARX_SETTINGS_PATH:-/etc/searxng/settings.yml}
    volumes:
      - searxng_data:/data
      - ./searxng-settings-mine.yml:/data/searxng-settings-mine.yml
      - ./searxng-limiter.toml:/data/searxng-limiter.toml

volumes:
  morphic-data:
  redis_data:
  searxng_data:
